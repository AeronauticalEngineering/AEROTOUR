<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ประวัติการจอง - AEROTOUR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="config.js"></script>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #EB8012;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-95 flex items-center justify-center z-50">
    <div class="text-center">
      <div class="spinner mx-auto mb-4"></div>
      <p class="text-[#0A164D] font-medium">กำลังโหลด...</p>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-gradient-to-r from-[#0A164D] to-[#1a2d6b] text-white sticky top-0 z-40 shadow-lg">
    <div class="px-4 py-4">
      <h1 class="text-xl font-bold">AEROTOUR</h1>
      <p class="text-sm text-gray-200">ประวัติการจองกิจกรรม</p>
    </div>
  </header>

  <!-- Main Content -->
  <div class="p-4 space-y-4">
    
    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-md p-4">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">สถานะ</label>
          <select id="filter-status" class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-[#EB8012] focus:border-transparent">
            <option value="">ทั้งหมด</option>
            <option value="จอง">จอง</option>
            <option value="เข้าร่วม">เข้าร่วม</option>
            <option value="ยกเลิก">ยกเลิก</option>
            <option value="จบกิจกรรม">จบกิจกรรม</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">วันที่</label>
          <input type="date" id="filter-date" class="w-full border border-gray-300 rounded-lg px-3 py-2.5 focus:ring-2 focus:ring-[#EB8012] focus:border-transparent">
        </div>
      </div>
    </div>

    <!-- Events Container -->
    <div id="groups-container" class="space-y-4"></div>
  </div>
  <script>
    let tableData = [];   // ของ user
    let allGroups = {};   // ของทุกคน
    let eventCaps = {};   // capacity จาก Events
    let currentUserId;

    function startLoading() { $('#loading-overlay').show(); }
    function stopLoading() { $('#loading-overlay').hide(); }

    async function initLIFF() {
      await liff.init({ liffId: LIFF_HISTORY });
      if (!liff.isLoggedIn()) return liff.login();
      const profile = await liff.getProfile();
      currentUserId = profile.userId;
      fetchData();
    }

    async function fetchData() {
      startLoading();
      try {
        const resp = await fetch(ADMIN_URL);
        const { appointments, events } = await resp.json();

        // 1) สร้าง map capacity
        eventCaps = {};
        events.slice(1).forEach(r => {
          const [id, , , cap] = r;
          eventCaps[String(id)] = Number(cap) || 0;
        });

        // 2) แปลง appointments ทั้งหมด → allAppointments
        const allAppointments = appointments.slice(1).map(r => ({
          id: String(r[0]), eventId: String(r[1]), activityName: r[2], category: r[3],
          price: r[4], date: r[5], time: r[6], queue: r[7], bookerName: r[8],
          bookerENG: r[9], idCard: r[10], address: r[11], phone: r[12], email: r[13],
          note: r[14], status: r[15], payment: r[16], joinStatus: r[17],
          confirmStatus: r[18], additionalNotes: r[19],
          useridline: r[20], invoice: r[21], receipt: r[22], certificate: r[23]  //
        }));

        // 3) สร้าง allGroups เพื่อคำนวณ booked ไม่กรอง user
        allGroups = allAppointments.reduce((acc, cur) => {
          (acc[cur.eventId] = acc[cur.eventId] || []).push(cur);
          return acc;
        }, {});

        // 4) กรองแถวที่จะโชว์ สำหรับ currentUserId
        tableData = allAppointments.filter(x => x.useridline === currentUserId);

        renderGroups();
      } catch (e) {
        console.error(e);
        Swal.fire('Error', 'ไม่สามารถโหลดข้อมูลได้', 'error');
      } finally {
        stopLoading();
      }
    }

    function groupBy(arr, key) {
      return arr.reduce((acc, cur) => {
        (acc[cur[key]] = acc[cur[key]] || []).push(cur);
        return acc;
      }, {});
    }

    // แสดงกลุ่ม พร้อมจำนวนจอง/จำนวนสูงสุด
    function renderGroups() {
      const statusFilter = $('#filter-status').val();
      const dateFilter = $('#filter-date').val();

      let filtered;
      if (statusFilter) {
        filtered = tableData.filter(x => x.status === statusFilter);
      } else {
        filtered = tableData.filter(x => x.status !== '');
      }

      if (dateFilter) {
        const [y, m, d] = dateFilter.split('-');
        filtered = filtered.filter(x => x.date === `${d}-${m}-${y}`);
      }

      const groups = groupBy(filtered, 'eventId');
      const cont = $('#groups-container').empty();

      for (const [eid, items] of Object.entries(groups)) {
        const h = items[0];
        const booked = allGroups[eid] ? allGroups[eid].length : 0;
        const cap = eventCaps[eid] || 0;
        const percentage = cap > 0 ? Math.round((booked / cap) * 100) : 0;
        
        // Color coding
        let badgeColor, progressColor;
        if (percentage >= 100) {
          badgeColor = 'bg-red-100 text-red-700';
          progressColor = 'bg-red-500';
        } else if (percentage >= 80) {
          badgeColor = 'bg-orange-100 text-orange-700';
          progressColor = 'bg-orange-500';
        } else if (percentage >= 50) {
          badgeColor = 'bg-yellow-100 text-yellow-700';
          progressColor = 'bg-yellow-500';
        } else {
          badgeColor = 'bg-green-100 text-green-700';
          progressColor = 'bg-green-500';
        }

        const box = $(`
          <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="bg-gradient-to-r from-[#0A164D] to-[#1a2d6b] text-white p-4">
              <h3 class="font-bold text-lg mb-1">${h.activityName}</h3>
              <p class="text-sm text-gray-200">${h.date} ${h.time}</p>
              
              <div class="mt-3 flex items-center gap-2">
                <span class="px-3 py-1 rounded-full text-xs font-medium ${badgeColor}">${booked}/${cap} คน (${percentage}%)</span>
              </div>
              
              <div class="mt-2 bg-gray-200 rounded-full h-2 overflow-hidden">
                <div class="${progressColor} h-full transition-all duration-300" style="width: ${Math.min(percentage, 100)}%"></div>
              </div>
            </div>

            <div class="p-4">
              <div class="space-y-2" data-event-id="${eid}">
                ${items.slice(0, 10).map(it => `
                  <div class="border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-2">
                      <div class="flex-1">
                        <p class="font-medium text-gray-900">${it.bookerName}</p>
                        <p class="text-xs text-gray-500 mt-1">${it.queue} ที่นั่ง</p>
                      </div>
                      <button class="text-[#0A164D] font-medium text-sm" onclick="toggleDetailsInGroup('${it.id}', this)">
                        <span class="toggle-icon">▼</span>
                      </button>
                    </div>
                    
                    <div class="flex gap-2 flex-wrap">
                      <span class="px-2 py-1 rounded-md text-xs font-medium ${it.status === 'จอง' ? 'bg-blue-100 text-blue-700' : it.status === 'เข้าร่วม' ? 'bg-green-100 text-green-700' : it.status === 'ยกเลิก' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}">${it.status}</span>
                      <span class="px-2 py-1 rounded-md text-xs font-medium ${it.confirmStatus === 'ยืนยัน' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${it.confirmStatus}</span>
                    </div>
                  </div>
                `).join('')}
              </div>
              
              ${items.length > 10 ? `
                <button class="w-full mt-3 bg-gradient-to-r from-[#EB8012] to-[#ff9933] text-white py-2.5 rounded-lg font-medium hover:shadow-lg transition-all" onclick="loadMoreItems('${eid}')">
                  แสดงเพิ่มเติม (${items.length - 10})
                </button>
              ` : ''}
            </div>
          </div>
        `);
        
        box.data('allItems', items);
        box.data('displayedCount', 10);
        cont.append(box);
      }
    }

    function loadMoreItems(eventId) {
      const container = $(`[data-event-id="${eventId}"]`).closest('.bg-white');
      const allItems = container.data('allItems');
      let displayedCount = container.data('displayedCount') || 10;
      const nextBatch = allItems.slice(displayedCount, displayedCount + 10);
      
      nextBatch.forEach(it => {
        $(`[data-event-id="${eventId}"]`).append(`
          <div class="border border-gray-200 rounded-lg p-3 hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-2">
              <div class="flex-1">
                <p class="font-medium text-gray-900">${it.bookerName}</p>
                <p class="text-xs text-gray-500 mt-1">${it.queue} ที่นั่ง</p>
              </div>
              <button class="text-[#0A164D] font-medium text-sm" onclick="toggleDetailsInGroup('${it.id}', this)">
                <span class="toggle-icon">▼</span>
              </button>
            </div>
            
            <div class="flex gap-2 flex-wrap">
              <span class="px-2 py-1 rounded-md text-xs font-medium ${it.status === 'จอง' ? 'bg-blue-100 text-blue-700' : it.status === 'เข้าร่วม' ? 'bg-green-100 text-green-700' : it.status === 'ยกเลิก' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}">${it.status}</span>
              <span class="px-2 py-1 rounded-md text-xs font-medium ${it.confirmStatus === 'ยืนยัน' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${it.confirmStatus}</span>
            </div>
          </div>
        `);
      });
      
      displayedCount += nextBatch.length;
      container.data('displayedCount', displayedCount);
      
      if (displayedCount >= allItems.length) {
        container.find('button:contains("แสดงเพิ่มเติม")').remove();
      } else {
        container.find('button:contains("แสดงเพิ่มเติม")').text(`แสดงเพิ่มเติม (${allItems.length - displayedCount})`);
      }
    }

    function toggleDetailsInGroup(itemId, btn) {
      const $btn = $(btn);
      const $card = $btn.closest('.border');
      const $existing = $card.find('.details-panel');
      
      if ($existing.length > 0) {
        $existing.slideUp(200, function() { $(this).remove(); });
        $btn.find('.toggle-icon').text('▼');
        return;
      }
      
      $btn.find('.toggle-icon').text('▲');
      const it = tableData.find(x => x.id === itemId);
      
      const html = `
        <div class="details-panel mt-3 pt-3 border-t-2 border-[#EB8012]">
          <div class="bg-gradient-to-br from-gray-50 to-white rounded-lg p-3">
            <div class="grid grid-cols-1 gap-3 text-xs">
              <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                <div><span class="text-gray-500">ID:</span> <span class="font-medium">${it.id}</span></div>
                <div><span class="text-gray-500">กิจกรรม:</span> <span class="font-medium">${it.activityName}</span></div>
                <div><span class="text-gray-500">หมวดหมู่:</span> <span class="font-medium">${it.category}</span></div>
                <div><span class="text-gray-500">ราคา:</span> <span class="font-medium">${it.price} บาท</span></div>
                <div><span class="text-gray-500">วัน/เวลา:</span> <span class="font-medium">${it.date} ${it.time}</span></div>
                <div><span class="text-gray-500">จำนวน:</span> <span class="font-medium">${it.queue} ที่นั่ง</span></div>
                <div><span class="text-gray-500">เลขบัตร:</span> <span class="font-medium">${it.idCard}</span></div>
                <div><span class="text-gray-500">ชื่อ-สกุล:</span> <span class="font-medium">${it.bookerName}</span></div>
                <div><span class="text-gray-500">ชื่อ ENG:</span> <span class="font-medium">${it.bookerENG}</span></div>
                <div><span class="text-gray-500">ที่อยู่:</span> <span class="font-medium">${it.address}</span></div>
                <div><span class="text-gray-500">โทร:</span> <span class="font-medium">${it.phone}</span></div>
                <div><span class="text-gray-500">อีเมล:</span> <span class="font-medium">${it.email}</span></div>
                <div class="col-span-2"><span class="text-gray-500">หมายเหตุ:</span> <span class="font-medium">${it.note || '-'}</span></div>
              </div>
              
              <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2">
                <div class="bg-blue-50 p-2 rounded-lg">
                  <div class="text-xs text-gray-500">สถานะ</div>
                  <div class="font-medium text-sm">${it.status}</div>
                </div>
                <div class="bg-green-50 p-2 rounded-lg">
                  <div class="text-xs text-gray-500">ชำระเงิน</div>
                  <div class="font-medium text-sm">${it.payment}</div>
                </div>
                <div class="bg-yellow-50 p-2 rounded-lg">
                  <div class="text-xs text-gray-500">แจ้งเข้าร่วม</div>
                  <div class="font-medium text-sm">${it.joinStatus}</div>
                </div>
                <div class="bg-purple-50 p-2 rounded-lg">
                  <div class="text-xs text-gray-500">ยืนยัน</div>
                  <div class="font-medium text-sm">${it.confirmStatus}</div>
                </div>
              </div>
              
              ${it.invoice || it.receipt || it.certificate ? `
              <div class="bg-gray-50 p-3 rounded-lg">
                <div class="text-xs font-medium text-gray-600 mb-2">เอกสาร</div>
                <div class="grid grid-cols-2 gap-2">
                  ${it.invoice ? `<a href="${it.invoice}" target="_blank" class="text-xs text-blue-600 hover:text-blue-700 bg-white p-2 rounded">ใบแจ้งหนี้</a>` : ''}
                  ${it.receipt ? `<a href="${it.receipt}" target="_blank" class="text-xs text-blue-600 hover:text-blue-700 bg-white p-2 rounded">ใบเสร็จ</a>` : ''}
                  ${it.certificate ? `<a href="${it.certificate}" target="_blank" class="text-xs text-blue-600 hover:text-blue-700 bg-white p-2 rounded">ใบรับรอง</a>` : ''}
                </div>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      
      $card.append(html);
      $card.find('.details-panel').hide().slideDown(200);
    }

    window.onload = initLIFF;
    $('#filter-status, #filter-date').on('change', renderGroups);

  </script>
</body>

</html>
