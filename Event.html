<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>AEROTOUR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script src="config.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <style>
    :root {
      --primary-color: #ffffff;
      --secondary-color: #0A164D;
      --accent-color: #EB8012;
    }

    .flying-image {
      position: absolute;
      padding-top: -20px;
      width: 100px;
      animation: fly 5s linear infinite, tilt 1s ease-in-out infinite alternate;
    }

    @keyframes fly {
      0% { transform: translate(0, 0); }
      25% { transform: translate(100px, -50px); }
      50% { transform: translate(200px, 50px); }
      75% { transform: translate(100px, 100px); }
      100% { transform: translate(0, 0); }
    }

    @keyframes tilt {
      0% { transform: rotate(5deg); }
      100% { transform: rotate(-5deg); }
    }

    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    .glass {
      background: rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
      backdrop-filter: blur(3.5px);
      -webkit-backdrop-filter: blur(3.5px);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    #toast.error {
      background-color: #dc2626; /* bg-red-600 */
      color: white;
    }
  </style>
</head>

<body class="bg-gradient-to-b from-blue-100 via-orange-100 to-white min-h-screen relative bg-fixed">
  <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-[#F5F8FD] z-50">
    <div class="text-center">
      <div class="relative flex w-48">
        <div class="flex-1 mb-40">
          <img src="https://lh5.googleusercontent.com/d/1MoIcHrUlOtTV46t5CI3bYwT0cGQBh7PB" alt="Flying Object" class="flying-image w-48 mx-auto">
        </div>
      </div>
    </div>
  </div>

  <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-2xl shadow-lg max-w-xs w-full">
      <h3 class="text-lg font-semibold mb-4">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
      <p id="modalMessage" class="text-sm text-gray-700 mb-6"></p>
      <button id="modalOk" class="w-full py-2 rounded-lg bg-[#071d4a] text-white">‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>
  </div>

  <div id="step1" class="p-4 max-w-md mx-auto">
    <div class="swiper mySwiper max-w-md mx-auto mb-4 rounded-xl overflow-hidden shadow-lg">
      <div class="swiper-wrapper" id="bannerWrapper"></div>
      <div class="swiper-pagination"></div>
    </div>
    <div class="px-2 py-4 mb-4">
      <div id="categoryFilter" class="flex flex-wrap gap-2 justify-center"></div>
    </div>
    <div id="step1EventList" class="grid grid-cols-2 gap-4"></div>
  </div>

  <div id="step2" class="hidden p-4 max-w-md mx-auto">
    <button id="backToStep1" class="bg-[#DD7929] mb-4 px-6 py-2 text-white rounded-full">‡∏Å‡∏•‡∏±‡∏ö</button>
    <img id="detailMainImg" class="w-full h-48 object-cover rounded-2xl mb-4" />
    <div id="detailGallery" class="flex space-x-2 overflow-x-auto mb-4"></div>
    <div class="flex items-center">
      <h2 id="detailEventName" class="text-lg font-bold"></h2>
      <p id="detailEventCategory" class="text-sm bg-orange-100 text-orange-800 px-2 py-1 rounded-full ml-2"></p>
    </div>
    <div class="flex justify-between items-center mb-2 mt-2">
      <div class="flex items-center text-sm text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" class="mr-2"><path d="M16 2V6M8 2V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path d="M13 4H11C7.22876 4 5.34315 4 4.17157 5.17157C3 6.34315 3 8.22876 3 12V14C3 17.7712 3 19.6569 4.17157 20.8284C5.34315 22 7.22876 22 11 22H13C16.7712 22 18.6569 22 19.8284 20.8284C21 19.6569 21 17.7712 21 14V12C21 8.22876 21 6.34315 19.8284 5.17157C18.6569 4 16.7712 4 13 4Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /><path d="M3 10H21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /></svg>
        <span id="detailEventDateTime"></span>
      </div>
      <div id="detailEventPrice" class="text-2xl font-bold text-red-500"></div>
    </div>
    <div class="flex justify-between items-center mb-4 mt-4">
      <div id="detailEventQueue" class="w-40 text-center rounded-full border-2 border-orange-500 px-4 py-2 font-bold text-orange-500"></div>
      <div class="w-full ml-4">
        <button id="detailBookBtn" class="w-full px-4 py-2 rounded-2xl text-white bg-[#071d4a]">‡∏à‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ</button>
      </div>
    </div>
    <div>
      <div class="text-md py-2 font-semibold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
      <p id="detailEventDesc" class="text-sm text-gray-700 mb-2"></p>
      <p id="detailEventDesc2" class="text-sm text-gray-700 mb-4"></p>
    </div>
  </div>

  <div id="step3" class="hidden p-4 max-w-md mx-auto">
    <button id="backToStep2" class="bg-[#DD7929] mb-4 px-6 py-2 text-white rounded-full">‡∏Å‡∏•‡∏±‡∏ö</button>
    <form id="bookingForm" class="space-y-4 bg-white p-4 rounded-2xl shadow">
      <input type="hidden" id="bookEventId" required />
      <div>
        <label class="block text-xs text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
        <input type="text" id="bookEventName" class="w-full border-b bg-gray-50" readonly />
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs text-gray-500">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
          <input type="text" id="bookEventCategory" class="w-full border-b rounded-lg p-1 bg-orange-100 text-center" readonly />
        </div>
        <div>
          <label class="block text-xs text-gray-500">‡∏£‡∏≤‡∏Ñ‡∏≤</label>
          <input type="text" id="bookEventPrice" class="w-full border-b rounded-lg p-1 bg-orange-100 text-center" readonly />
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="text" id="bookEventDate" class="w-full border-b rounded-lg p-1 bg-orange-100 text-center" readonly />
        </div>
        <div>
          <label class="block text-xs text-gray-500">‡πÄ‡∏ß‡∏•‡∏≤</label>
          <input type="text" id="bookEventTime" class="w-full border-b p-1 rounded-lg bg-orange-100 text-center" readonly />
        </div>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
        <input type="text" id="bookRenterName" class="w-full border rounded-lg p-2 text-sm" required />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• (English)</label>
        <input type="text" id="bookRenterNameEn" class="w-full border rounded-lg p-2 text-sm" required />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
        <input type="text" id="bookCitizenId" class="w-full border rounded-lg p-2 text-sm" maxlength="13" required />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
        <textarea id="bookAddress" class="w-full border rounded-lg p-2 text-sm" rows="3" required></textarea>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
        <input type="tel" id="bookPhone" class="w-full border rounded-lg p-2 text-sm" required />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input type="email" id="bookEmail" class="w-full border rounded-lg p-2 text-sm" required />
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <textarea id="bookNote" class="w-full border rounded-lg p-2 text-sm" rows="3"></textarea>
      </div>
      <input type="hidden" id="bookUserLineId" required />
      <button type="button" id="submitBookingBtn" class="bg-[#071d4a] text-white w-full py-3 rounded-lg text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
    </form>
  </div>

  <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-75 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>
  
  <script>
    // --- Global Variables ---
    let eventsData = [];
    let selectedEvent = null;
    let swiperInstance;

    // --- Helper Functions ---
    const formatDate = d => {
      const dt = new Date(d);
      const dd = String(dt.getDate()).padStart(2, '0');
      const mm = String(dt.getMonth() + 1).padStart(2, '0');
      const yyyy = dt.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    };
    const formatTime = d => {
      const dt = new Date(d);
      const hh = String(dt.getHours()).padStart(2, '0');
      const mi = String(dt.getMinutes()).padStart(2, '0');
      return `${hh}:${mi}`;
    };

    // --- UI Control ---
    const showStep = id => {
      ['step1', 'step2', 'step3'].forEach(s => document.getElementById(s).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      window.scrollTo(0, 0);
    };
    const showLoading = () => document.getElementById('loadingOverlay').classList.remove('hidden');
    const hideLoading = () => document.getElementById('loadingOverlay').classList.add('hidden');

    const showModal = (msg, onOk) => {
      const modal = document.getElementById('customModal');
      document.getElementById('modalMessage').textContent = msg;
      modal.classList.remove('hidden');
      document.getElementById('modalOk').onclick = () => {
        modal.classList.add('hidden');
        if (typeof onOk === 'function') onOk();
      };
    };

    // --- Data Fetching and Rendering ---
    const fetchAllEvents = async () => {
      showLoading();
      try {
        const res = await fetch(EVENT_URL);
        const data = await res.json();
        eventsData = data.events;
        renderCategoryButtons(eventsData);
        renderEventList(eventsData);
        renderBannersWithSwiper(data.banners);
      } catch (e) {
        console.error('Fetch events failed:', e);
        showModal('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
      } finally {
        hideLoading();
      }
    };

    const renderBannersWithSwiper = banners => {
      const wrapper = document.getElementById('bannerWrapper');
      wrapper.innerHTML = banners.map(b => `<div class="swiper-slide"><img src="${b['‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå']}" alt="banner" class="w-full h-24 object-cover" /></div>`).join('');
      if (swiperInstance) swiperInstance.destroy(true, true);
      swiperInstance = new Swiper(".mySwiper", {
        loop: true,
        autoplay: { delay: 4000, disableOnInteraction: false },
        pagination: { el: ".swiper-pagination", clickable: true },
      });
    };

    const renderEventList = events => {
      const container = document.getElementById("step1EventList");
      container.innerHTML = "";
      if (events.length === 0) {
        container.innerHTML = `<p class="col-span-2 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</p>`;
        return;
      }
      events.forEach(evt => {
        const booked = Number(evt["‡∏Ñ‡∏¥‡∏ß"]) || 0;
        const total = Number(evt["‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≥‡∏Å‡∏±‡∏î"]) || 0;
        const isFull = booked >= total;

        const card = document.createElement("div");
        card.className = "relative bg-white rounded-2xl shadow-lg overflow-hidden";
        card.innerHTML = `
          <div class="relative">
            <img src="${evt["‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"]}" class="w-full h-32 object-cover" onerror="this.src='placeholder.png';">
            <div class="absolute top-2 left-2 bg-orange-500 text-white text-sm font-bold px-3 py-1 rounded-full">${evt["‡∏£‡∏≤‡∏Ñ‡∏≤"]} ‡∏ö‡∏≤‡∏ó</div>
          </div>
          <div class="p-3 flex flex-col gap-2">
            <div class="flex justify-between items-start">
              <div class="text-md font-bold text-[#0D1C4D] pr-2">${evt["‡∏ä‡∏∑‡πà‡∏≠"] || "Eventname"}</div>
              <div class="text-[#0D1C4D] text-sm font-bold flex-shrink-0">${booked}/${total}</div>
            </div>
            <div class="flex justify-between items-stretch">
              <div class="flex flex-col justify-center">
                <div class="flex items-center text-xs mb-1">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" class="mr-1"><path d="M16 2V6M8 2V6" stroke="currentColor" stroke-width="1.5" /><path d="M13 4H11C7.22876 4 5.34315 4 4.17157 5.17157C3 6.34315 3 8.22876 3 12V14C3 17.7712 3 19.6569 4.17157 20.8284C5.34315 22 7.22876 22 11 22H13C16.7712 22 18.6569 22 19.8284 20.8284C21 19.6569 21 17.7712 21 14V12C21 8.22876 21 6.34315 19.8284 5.17157C18.6569 4 16.7712 4 13 4Z" stroke="currentColor" stroke-width="1.5" /><path d="M3 10H21" stroke="currentColor" stroke-width="1.5" /></svg>
                  <span>${formatDate(evt["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"])}</span>
                </div>
                <div class="flex items-center text-xs">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" class="mr-1"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" /><path d="M9.5 9.5L12.9999 12.9996M16 8L11 13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" /></svg>
                  <span>${formatTime(evt["‡πÄ‡∏ß‡∏•‡∏≤"])}</span>
                </div>
              </div>
              <button class="select-btn mt-2 px-4 py-1 rounded-xl text-white ${isFull ? 'bg-gray-400 cursor-not-allowed' : 'bg-[#071D4A]'}" ${isFull ? 'disabled' : ''}>${isFull ? "‡πÄ‡∏ï‡πá‡∏°" : "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"}</button>
            </div>
          </div>
        `;
        if (!isFull) {
            card.querySelector('.select-btn').onclick = () => {
                selectedEvent = evt;
                populateDetail();
            };
        }
        container.appendChild(card);
      });
    };

    const renderCategoryButtons = events => {
      const catContainer = document.getElementById('categoryFilter');
      const allCategories = ["‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", ...new Set(events.map(evt => evt["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"]).filter(Boolean))];
      catContainer.innerHTML = allCategories.map((cat, index) => 
        `<button class="cat-btn px-4 py-2 rounded-lg text-sm ${index === 0 ? 'bg-[#071d4a] text-white' : 'bg-white text-gray-700'}">${cat}</button>`
      ).join('');
      
      const buttons = catContainer.querySelectorAll('.cat-btn');
      buttons.forEach(btn => {
        btn.onclick = () => {
          buttons.forEach(b => b.classList.replace('bg-[#071d4a]', 'bg-white') || b.classList.replace('text-white', 'text-gray-700'));
          btn.classList.add('bg-[#071d4a]', 'text-white');
          btn.classList.remove('bg-white', 'text-gray-700');
          
          const category = btn.textContent;
          const filtered = category === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ? eventsData : eventsData.filter(evt => evt["‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"] === category);
          renderEventList(filtered);
        };
      });
    };

    // --- Page Population ---
    const populateDetail = () => {
      showStep('step2');
      const booked = Number(selectedEvent['‡∏Ñ‡∏¥‡∏ß']) || 0;
      const total = Number(selectedEvent['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≥‡∏Å‡∏±‡∏î']) || 0;
      const isFull = booked >= total;

      document.getElementById('detailMainImg').src = selectedEvent['‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'];
      document.getElementById('detailEventName').textContent = selectedEvent['‡∏ä‡∏∑‡πà‡∏≠'];
      document.getElementById('detailEventCategory').textContent = selectedEvent['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'];
      document.getElementById('detailEventDateTime').textContent = `${formatDate(selectedEvent['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'])} - ${formatTime(selectedEvent['‡πÄ‡∏ß‡∏•‡∏≤'])}`;
      document.getElementById('detailEventQueue').textContent = `‡∏Ñ‡∏¥‡∏ß: ${booked}/${total}`;
      document.getElementById('detailEventPrice').textContent = `${selectedEvent['‡∏£‡∏≤‡∏Ñ‡∏≤']} ‡∏ö‡∏≤‡∏ó`;
      document.getElementById('detailEventDesc').textContent = selectedEvent['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'];
      document.getElementById('detailEventDesc2').textContent = selectedEvent['‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î-2'];

      const gallery = document.getElementById('detailGallery');
      gallery.innerHTML = '';
      ['‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö-1', '‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö-2', '‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö-3', '‡∏£‡∏π‡∏õ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö-4'].forEach(key => {
        if (selectedEvent[key]) {
          const thumb = document.createElement('img');
          thumb.src = selectedEvent[key];
          thumb.className = 'w-20 h-16 object-cover rounded-lg cursor-pointer';
          thumb.onclick = () => { document.getElementById('detailMainImg').src = selectedEvent[key]; };
          gallery.appendChild(thumb);
        }
      });

      const btn = document.getElementById('detailBookBtn');
      btn.textContent = isFull ? '‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏à‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ';
      btn.disabled = isFull;
      btn.className = `w-full px-4 py-2 rounded-2xl text-white ${isFull ? 'bg-gray-400 cursor-not-allowed' : 'bg-[#071d4a]'}`;
      if (!isFull) {
        btn.onclick = () => populateBookingForm();
      }
    };
    
    const populateBookingForm = () => {
      showStep('step3');
      document.getElementById('bookEventId').value = selectedEvent['‡πÑ‡∏≠‡∏î‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'];
      document.getElementById('bookEventName').value = selectedEvent['‡∏ä‡∏∑‡πà‡∏≠'];
      document.getElementById('bookEventCategory').value = selectedEvent['‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'];
      document.getElementById('bookEventPrice').value = `${selectedEvent['‡∏£‡∏≤‡∏Ñ‡∏≤']} ‡∏ö‡∏≤‡∏ó`;
      document.getElementById('bookEventDate').value = formatDate(selectedEvent['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']);
      document.getElementById('bookEventTime').value = formatTime(selectedEvent['‡πÄ‡∏ß‡∏•‡∏≤']);
    };
    
    // --- Form Submission ---
    const submitBooking = async () => {
      const btn = document.getElementById('submitBookingBtn');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
      btn.classList.add('bg-gray-400');
      
      const requiredFields = [
        { id: 'bookRenterName', label: '‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•' },
        { id: 'bookRenterNameEn', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©' },
        { id: 'bookCitizenId', label: '‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß' },
        { id: 'bookAddress', label: '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà' },
        { id: 'bookPhone', label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' },
        { id: 'bookEmail', label: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•' },
      ];

      for (const field of requiredFields) {
        if (!document.getElementById(field.id).value.trim()) {
          showModal(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ${field.label}`);
          btn.disabled = false;
          btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
          btn.classList.remove('bg-gray-400');
          return;
        }
      }

      const payload = {
        eventId: document.getElementById('bookEventId').value,
        eventName: document.getElementById('bookEventName').value,
        category: document.getElementById('bookEventCategory').value,
        price: selectedEvent['‡∏£‡∏≤‡∏Ñ‡∏≤'],
        date: document.getElementById('bookEventDate').value,
        time: document.getElementById('bookEventTime').value,
        queue: "1",
        renterName: document.getElementById('bookRenterName').value,
        renterNameEn: document.getElementById('bookRenterNameEn').value,
        citizenId: document.getElementById('bookCitizenId').value,
        address: document.getElementById('bookAddress').value,
        phone: document.getElementById('bookPhone').value,
        email: document.getElementById('bookEmail').value,
        note: document.getElementById('bookNote').value,
        userLineId: document.getElementById('bookUserLineId').value
      };

      try {
        const response = await fetch(EVENT_URL, { method: 'POST', body: JSON.stringify(payload), headers: {'Content-Type': 'application/json'} });
        const result = await response.json();
        if (result.error) throw new Error(result.error);
        
        await fetchAllEvents();
        showModal('‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üéâ', () => {
          if (liff.isInClient()) {
            liff.closeWindow();
          } else {
            showStep('step1');
          }
        });
      } catch (e) {
        console.error('Submit booking failed:', e);
        showModal('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á';
        btn.classList.remove('bg-gray-400');
      }
    };
    
    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          const profile = await liff.getProfile();
          document.getElementById('bookUserLineId').value = profile.userId;
        }
      } catch (err) {
        console.error("LIFF Init failed", err);
        // Fallback for browsers without LIFF
        document.getElementById('bookUserLineId').value = 'browser_test_user';
      }
      
      await fetchAllEvents();
      
      document.getElementById('submitBookingBtn').onclick = submitBooking;
      document.getElementById('backToStep1').onclick = () => showStep('step1');
      document.getElementById('backToStep2').onclick = () => showStep('step2');
    });

  </script>
</body>
</html>
