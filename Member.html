<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>จัดการสมาชิก - AEROTOUR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="config.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex">

  <!-- Side Navigation -->
  <aside class="w-56 bg-[#0A164D] shadow-lg flex flex-col">
    <div class="p-4 text-white font-bold text-xl border-b border-[#EB8012]">
      <span>AEROTOUR</span>
    </div>
    <nav class="flex-1 mt-2 px-2">
      <a href="Dashboard.html" class="block p-3 text-gray-300 hover:bg-[#1a2d6b] rounded-lg mb-2 transition-all font-medium">
        Dashboard
      </a>
      <a href="addevent.html" class="block p-3 text-gray-300 hover:bg-[#1a2d6b] rounded-lg mb-2 transition-all font-medium">
        Event
      </a>
      <a href="#" class="block p-3 text-white bg-[#EB8012] rounded-lg transition-all font-medium">
        Member
      </a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-6">
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-[#0A164D] mb-1">จัดการสมาชิก</h1>
      <p class="text-sm text-gray-500">ข้อมูลสมาชิกและการจัดการ</p>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-2">ค้นหาชื่อสกุล</label>
          <input id="filter-name" type="text" placeholder="ชื่อสกุล" class="w-full border-2 border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-[#EB8012] focus:border-transparent outline-none transition-all text-sm" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-2">ค้นหา เบอร์ติดต่อ</label>
          <input id="filter-phone" type="text" placeholder="เบอร์ติดต่อ" class="w-full border-2 border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-[#EB8012] focus:border-transparent outline-none transition-all text-sm" />
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-2">ค้นหา บัตรปชช</label>
          <input id="filter-idcard" type="text" placeholder="บัตรประชาชน" class="w-full border-2 border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-[#EB8012] focus:border-transparent outline-none transition-all text-sm" />
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
      <table id="data-table" class="min-w-full">
        <thead class="bg-gradient-to-r from-[#0A164D] to-[#1a2d6b] text-white">
          <tr>
            <th class="py-4 px-4 text-left text-xs font-semibold">ไอดี</th>
            <th class="py-4 px-4 text-left text-xs font-semibold">ชื่อสกุล</th>
            <th class="py-4 px-4 text-left text-xs font-semibold">ชื่อสกุล(ENG)</th>
            <th class="py-4 px-4 text-left text-xs font-semibold">เบอร์ติดต่อ</th>
            <th class="py-4 px-4 text-left text-xs font-semibold">อีเมล</th>
            <th class="py-4 px-4 text-center text-xs font-semibold">จัดการ</th>
          </tr>
        </thead>
        <tbody class="text-sm"></tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="mt-6 flex justify-end gap-2"></div>
  </main>

  <!-- Profile Modal -->
  <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-xl shadow-2xl overflow-hidden">
      <div class="bg-gradient-to-r from-[#0A164D] to-[#1a2d6b] text-white p-5">
        <h2 class="text-lg font-bold">ข้อมูลสมาชิก</h2>
      </div>
      <div id="profile-content" class="p-6 space-y-3 text-sm max-h-[70vh] overflow-y-auto"></div>
      <div class="p-5 bg-gray-50 border-t text-right">
        <button onclick="closeProfileModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2.5 rounded-lg font-medium transition-all">ปิด</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl w-full max-w-3xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
      <div class="bg-gradient-to-r from-[#0A164D] to-[#1a2d6b] text-white p-5">
        <h2 class="text-lg font-bold">แก้ไขข้อมูลสมาชิก</h2>
      </div>
      <form id="edit-form" class="p-6 overflow-y-auto flex-1">
        <input type="hidden" id="edit-id" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-2">ชื่อสกุล</label>
            <input id="edit-name" type="text" class="w-full border-2 border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-[#EB8012] focus:border-transparent outline-none text-sm" required />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-2">ชื่อสกุล(ENG)</label>
            <input id="edit-name-en" type="text" class="w-full border-2 border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-[#EB8012] focus:border-transparent outline-none text-sm" required />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-2">บัตรปชช</label>
            <input id="edit-idcard" type="text" class="w-full border-2 border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-[#EB8012] focus:border-transparent outline-none text-sm" required />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-2">ที่อยู่</label>
            <input id="edit-address" type="text" class="w-full border-2 border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-[#EB8012] focus:border-transparent outline-none text-sm" required />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-2">เบอร์ติดต่อ</label>
            <input id="edit-phone" type="text" class="w-full border-2 border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-[#EB8012] focus:border-transparent outline-none text-sm" required />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-2">อีเมล</label>
            <input id="edit-email" type="email" class="w-full border-2 border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-[#EB8012] focus:border-transparent outline-none text-sm" />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-2">useridline</label>
            <input id="edit-userline" type="text" class="w-full border-2 border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-[#EB8012] focus:border-transparent outline-none text-sm" />
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-2">คะแนน</label>
            <input id="edit-score" type="number" class="w-full border-2 border-gray-300 px-4 py-2 rounded-lg focus:ring-2 focus:ring-[#EB8012] focus:border-transparent outline-none text-sm" />
          </div>
        </div>
        <div class="flex gap-3 mt-6">
          <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-3 rounded-lg font-medium transition-all">ยกเลิก</button>
          <button type="submit" class="flex-1 bg-gradient-to-r from-[#EB8012] to-[#ff9933] hover:from-[#d67010] hover:to-[#EB8012] text-white px-4 py-3 rounded-lg font-medium transition-all shadow-lg">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 flex flex-col items-center shadow-2xl">
      <div class="animate-spin rounded-full h-16 w-16 border-4 border-[#EB8012] border-t-transparent mb-4"></div>
      <span class="text-[#0A164D] text-lg font-medium">กรุณารอสักครู่...</span>
    </div>
  </div>

  <script>
    // —————– Helper Loading —————–
    function showLoading(text = 'กำลังโหลด...') {
      $('#loading-overlay').removeClass('hidden');
      $('button').prop('disabled', true);
    }
    function closeLoading() {
      $('#loading-overlay').addClass('hidden');
      $('button').prop('disabled', false);
    }

    // —————– Core Variables —————–
    const rowsPerPage = 10;
    let tableData = [], filteredData = [], currentPage = 1;

    // —————– Fetch Data —————–
    async function fetchData() {
      showLoading('กำลังโหลดข้อมูลสมาชิก...');
      try {
        const res = await fetch(`${MEMBER_URL}?action=fetchData`);
        const data = await res.json();
        tableData = data.slice(1);
        applyFilters();
        setupPagination();
      } catch (e) {
        console.error(e);
        Swal.fire('ผิดพลาด', 'โหลดข้อมูลไม่สำเร็จ', 'error');
      } finally {
        closeLoading();
      }
    }

    // —————– Display Page —————–
    function displayPage(page) {
      const start = (page - 1) * rowsPerPage;
      const pageRows = filteredData.slice(start, start + rowsPerPage);
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';

      pageRows.forEach(row => {
        if (row.every(c => c === '')) return;
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-100 hover:bg-gray-50 transition-colors';
        
        [0,1,2,5,6].forEach(i => {
          const td = document.createElement('td');
          td.className = 'py-3 px-4 text-gray-700';
          td.textContent = row[i] || '';
          tr.appendChild(td);
        });
        
        const actionTd = document.createElement('td');
        actionTd.className = 'py-3 px-4 text-center';

        const btnView = document.createElement('button');
        btnView.textContent = 'ดู';
        btnView.className = 'bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-all mr-1';
        btnView.onclick = () => viewProfile(row);

        const btnEdit = document.createElement('button');
        btnEdit.textContent = 'แก้ไข';
        btnEdit.className = 'bg-[#EB8012] hover:bg-[#d67010] text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-all mr-1';
        btnEdit.onclick = () => openEditModal(row);

        const btnDelete = document.createElement('button');
        btnDelete.textContent = 'ลบ';
        btnDelete.className = 'bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-all';
        btnDelete.onclick = () => confirmDelete(row[0]);

        actionTd.appendChild(btnView);
        actionTd.appendChild(btnEdit);
        actionTd.appendChild(btnDelete);
        tr.appendChild(actionTd);
        tbody.appendChild(tr);
      });
    }

    // —————– Pagination —————–
    function setupPagination() {
      const pageCount = Math.ceil(filteredData.length / rowsPerPage);
      const container = document.getElementById('pagination');
      container.innerHTML = '';
      
      if (pageCount <= 1) {
        displayPage(1);
        return;
      }

      // ปุ่มหน้าแรก
      const btnFirst = document.createElement('button');
      btnFirst.textContent = 'หน้าแรก';
      btnFirst.className = currentPage === 1
        ? 'px-4 py-2 bg-gray-200 text-gray-400 rounded-lg font-medium cursor-not-allowed'
        : 'px-4 py-2 bg-white hover:bg-gray-100 text-gray-700 rounded-lg font-medium shadow border border-gray-200 transition-all';
      btnFirst.disabled = currentPage === 1;
      btnFirst.onclick = () => {
        if (currentPage !== 1) {
          currentPage = 1;
          displayPage(1);
          setupPagination();
        }
      };
      container.appendChild(btnFirst);

      // ปุ่มก่อนหน้า
      const btnPrev = document.createElement('button');
      btnPrev.textContent = 'ก่อนหน้า';
      btnPrev.className = currentPage === 1
        ? 'px-4 py-2 bg-gray-200 text-gray-400 rounded-lg font-medium cursor-not-allowed'
        : 'px-4 py-2 bg-white hover:bg-gray-100 text-gray-700 rounded-lg font-medium shadow border border-gray-200 transition-all';
      btnPrev.disabled = currentPage === 1;
      btnPrev.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          displayPage(currentPage);
          setupPagination();
        }
      };
      container.appendChild(btnPrev);

      // แสดงเลขหน้า 3 ตัว
      let startPage = Math.max(1, currentPage - 1);
      let endPage = Math.min(pageCount, startPage + 2);
      
      // ปรับ startPage ถ้าอยู่ท้ายสุด
      if (endPage - startPage < 2) {
        startPage = Math.max(1, endPage - 2);
      }

      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = i === currentPage
          ? 'px-4 py-2 bg-[#EB8012] text-white rounded-lg font-medium shadow-lg'
          : 'px-4 py-2 bg-white hover:bg-gray-100 text-gray-700 rounded-lg font-medium shadow border border-gray-200 transition-all';
        btn.onclick = () => {
          currentPage = i;
          displayPage(i);
          setupPagination();
        };
        container.appendChild(btn);
      }

      // ปุ่มถัดไป
      const btnNext = document.createElement('button');
      btnNext.textContent = 'ถัดไป';
      btnNext.className = currentPage === pageCount
        ? 'px-4 py-2 bg-gray-200 text-gray-400 rounded-lg font-medium cursor-not-allowed'
        : 'px-4 py-2 bg-white hover:bg-gray-100 text-gray-700 rounded-lg font-medium shadow border border-gray-200 transition-all';
      btnNext.disabled = currentPage === pageCount;
      btnNext.onclick = () => {
        if (currentPage < pageCount) {
          currentPage++;
          displayPage(currentPage);
          setupPagination();
        }
      };
      container.appendChild(btnNext);

      // ปุ่มหน้าสุดท้าย
      const btnLast = document.createElement('button');
      btnLast.textContent = 'สุดท้าย';
      btnLast.className = currentPage === pageCount
        ? 'px-4 py-2 bg-gray-200 text-gray-400 rounded-lg font-medium cursor-not-allowed'
        : 'px-4 py-2 bg-white hover:bg-gray-100 text-gray-700 rounded-lg font-medium shadow border border-gray-200 transition-all';
      btnLast.disabled = currentPage === pageCount;
      btnLast.onclick = () => {
        if (currentPage !== pageCount) {
          currentPage = pageCount;
          displayPage(pageCount);
          setupPagination();
        }
      };
      container.appendChild(btnLast);

      displayPage(currentPage);
    }

    // —————– Filters —————–
    ['name','phone','idcard'].forEach(id => {
      document.getElementById(`filter-${id}`).addEventListener('input', applyFilters);
    });
    function applyFilters() {
      const nameValue = document.getElementById('filter-name').value.trim().toLowerCase();
      const phoneValue = document.getElementById('filter-phone').value.trim().toLowerCase();
      const idcardValue = document.getElementById('filter-idcard').value.trim().toLowerCase();

      filteredData = tableData.filter(r => {
        const nameCell = (r[1] || '').toString().toLowerCase();
        const phoneCell = (r[5] || '').toString().toLowerCase();
        const idcardCell = (r[3] || '').toString().toLowerCase();
        return nameCell.includes(nameValue)
            && phoneCell.includes(phoneValue)
            && idcardCell.includes(idcardValue);
      });

      currentPage = 1;
      setupPagination();
    }

    // —————– View Profile —————–
    function viewProfile(row) {
      const keys = ['ไอดี','ชื่อสกุล','ชื่อสกุล(ENG)','บัตรปชช','ที่อยู่','เบอร์ติดต่อ','อีเมล','useridline','คะแนน'];
      let html = '';
      keys.forEach((key,i) => {
        const val = row[i];
        if (val !== undefined && val !== '') {
          html += `<div class="border-b border-gray-100 pb-2"><span class="text-gray-500 text-xs">${key}:</span> <span class="font-medium text-gray-800">${val}</span></div>`;
        }
      });
      document.getElementById('profile-content').innerHTML = html;
      document.getElementById('profile-modal').classList.remove('hidden');
    }
    function closeProfileModal() {
      document.getElementById('profile-modal').classList.add('hidden');
    }

    // —————– Edit Modal —————–
    function openEditModal(row) {
      const fields = ['id','name','name-en','idcard','address','phone','email','userline','score'];
      fields.forEach((field,i) => {
        document.getElementById(`edit-${field}`).value = row[i] || '';
      });
      document.getElementById('edit-modal').classList.remove('hidden');
    }
    function closeEditModal() {
      document.getElementById('edit-modal').classList.add('hidden');
    }

    // —————– Submit Edit —————–
    document.getElementById('edit-form').addEventListener('submit', async e => {
      e.preventDefault();
      showLoading('กำลังบันทึกการแก้ไข...');
      try {
        const params = {
          method: 'updateData',
          id: document.getElementById('edit-id').value,
          nameTh: document.getElementById('edit-name').value,
          nameEn: document.getElementById('edit-name-en').value,
          idCard: document.getElementById('edit-idcard').value,
          address: document.getElementById('edit-address').value,
          phone: document.getElementById('edit-phone').value,
          email: document.getElementById('edit-email').value,
          userlineId: document.getElementById('edit-userline').value,
          score: document.getElementById('edit-score').value
        };
        const formBody = new URLSearchParams(params).toString();
        const res = await fetch(MEMBER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formBody
        });
        const msg = await res.text();
        Swal.fire('สำเร็จ', msg, 'success');
        closeEditModal();
        fetchData();
      } catch (e) {
        console.error(e);
        Swal.fire('ผิดพลาด', 'บันทึกไม่สำเร็จ', 'error');
      } finally {
        closeLoading();
      }
    });

    // —————– Delete Data —————–
    async function deleteData(id) {
      showLoading('กำลังลบข้อมูล...');
      try {
        const response = await fetch(MEMBER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `method=deleteData&id=${id}`
        });
        const result = await response.text();
        Swal.fire('ลบเรียบร้อย', result, 'success');
        fetchData();
      } catch (e) {
        console.error(e);
        Swal.fire('ผิดพลาด', 'ลบไม่สำเร็จ', 'error');
      } finally {
        closeLoading();
      }
    }
    function confirmDelete(id) {
      Swal.fire({
        title: "คุณแน่ใจหรือไม่?",
        text: "คุณต้องการลบข้อมูลนี้หรือไม่?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "ใช่, ลบเลย!"
      }).then(result => {
        if (result.isConfirmed) deleteData(id);
      });
    }

    // —————– Initialize —————–
    window.onload = fetchData;
  </script>
</body>
</html>
